<html>
    <head>
        <title>1st Assignment</title>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
        <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #render {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
    </head>
    <body>
        <canvas id="render" touch-action="none">
        <script>
            var canvas = document.getElementById("render");
            var engine = new BABYLON.Engine(canvas, true);
            var scene = new BABYLON.Scene(engine);
            // var camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 4, Math.PI / 4, 2000, new BABYLON.Vector3(0,0,-1500), scene);

            var createScene = function() {
                var scene = new BABYLON.Scene(engine);

                var env = BABYLON.Mesh.CreateBox("env", 7.0, scene);

                var target = BABYLON.MeshBuilder.CreateBox("target", {height: 2, width:2, depth:2}, scene);
                console.log(target)
                // var target = BABYLON.SceneLoader.ImportMesh("", "asset/Drone-Design/", "Drone_stl.stl", scene, function (droneMashes){});
                // var target = []

                var camera = new BABYLON.FreeCamera("Camera",target.position.clone(),scene);
                console.log(target)

                camera.attachControl(canvas, true);

                scene.actionManager = new BABYLON.ActionManager(scene);
                scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, (evt) => {
                    if (evt.sourceEvent.key == "w") {
                        target.__W_Pressed = true;
                    }
                    if (evt.sourceEvent.key == "s") {
                        target.__S_Pressed = true;
                    }
                    if (evt.sourceEvent.key == "a") {
                        target.__A_Pressed = true;
                    }
                    if (evt.sourceEvent.key == "d") {
                        target.__D_Pressed = true;
                    }
                    if (evt.sourceEvent.key == "q") {
                        target.__Q_Pressed = true;
                    }
                    if (evt.sourceEvent.key == "e") {
                        target.__E_Pressed = true;
                    }
                }));

                scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, (evt) => {
                    if (evt.sourceEvent.key == "w") {
                        target.__W_Pressed = false;
                    }
                    if (evt.sourceEvent.key == "s") {
                        target.__S_Pressed = false;
                    }
                    if (evt.sourceEvent.key == "a") {
                        target.__A_Pressed = false;
                    }
                    if (evt.sourceEvent.key == "d") {
                        target.__D_Pressed = false;
                    }
                    if (evt.sourceEvent.key == "q") {
                        target.__Q_Pressed = false;
                    }
                    if (evt.sourceEvent.key == "e") {
                        target.__E_Pressed = false;
                    }
                }));

                scene.registerBeforeRender(function(){
                    if(!scene.isReady()) return;

                    if(target){
                        if(target.__W_Pressed)
                            {
                                target.translate(BABYLON.Axis.Z, 0.1, BABYLON.Space.LOCAL);
                            }
                        if(target.__S_Pressed)
                            {
                                target.translate(BABYLON.Axis.Z, -0.1, BABYLON.Space.LOCAL);
                            }
                        if(target.__A_Pressed) 
                            {
                                target.translate(BABYLON.Axis.X, -0.1, BABYLON.Space.LOCAL);
                            }
                        if(target.__D_Pressed)
                            {
                                target.translate(BABYLON.Axis.X, 0.1, BABYLON.Space.LOCAL);
                            }
                        if(target.__Q_Pressed)
                            {
                                target.translate(BABYLON.Axis.Y, 0.1, BABYLON.Space.LOCAL);
                            }
                        if(target.__E_Pressed)
                            {
                                target.translate(BABYLON.Axis.Y, -0.1, BABYLON.Space.LOCAL);
                            }
                    }
                });

                scene.onBeforeRenderObservable.add(()=>{

                    camera.position = target.position.clone();
                    let ray = camera.getForwardRay();

                    for(i = 0; i < target.length; i++){
                        target[i].rotation.y = Math.atan2(ray.direction.x,ray.direction.z);
                    }
                    

                    camera.position = target.position.clone().add(ray.direction.multiplyByFloats(-10,-10,-10));
                });

                return scene;
            };

            var scene = createScene();
            engine.runRenderLoop(function() {
                // console.log(camera.position)
                scene.render();
            });
      window.addEventListener("resize", function() {
         engine.resize();
      });
        </script>
    </body>
</html>